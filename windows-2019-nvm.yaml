---
variables:
  nodejs_version: 12.18.3
  headless: 'true'
builders:
  - name: windows-2019-nvm-amd64-virtualbox
    type: virtualbox-ovf
    source_path: windows-2019-amd64-virtualbox.ova
    # checksum: sha256:68ef706501fffe4a07bdeb5fb18072c77b57ec1ae7312e4dc7d816ed2e9f10fa
    checksum: none
    guest_additions_mode: disable
    communicator: winrm
    winrm_username: vagrant
    winrm_password: vagrant
    shutdown_command: shutdown /s /t 0 /f /d p:4:1 /c "Packer Shutdown"
    headless: '{{user `headless`}}'
    format: ova
    export_opts:
      - --manifest
      - --ovf20
provisioners:
  - type: powershell
    inline:
      - Set-ExecutionPolicy Bypass -Scope Process -Force
      - "[System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072; iex ((New-Object System.Net.WebClient).DownloadString('https://chocolatey.org/install.ps1'))"
      - choco feature disable --name showDownloadProgress
  - type: powershell
    inline:
      - $ErrorActionPreference = "Stop"
      - $pieces=@('IIS-Applicationdevelopment', 'IIS-ASPNET45', 'IIS-WebSockets')
      - $pieces.ForEach({Write-Output $_; Enable-WindowsOptionalFeature -Online -All -Featurename $_})
      - iisreset
  - type: powershell
    inline:
      - 'choco install -y git.install --params "/GitAndUnixToolsOnPath"'
  - type: powershell
    inline: choco install -y dotnet4.6.1 dotnetfx googlechrome make microsoft-edge nvm.portable sysinternals wget zip
    valid_exit_codes:
      - 0
      - 3010
  - type: windows-restart
  - type: powershell
    environment_vars: "NODEJS_VERSION={{user `nodejs_version`}}"
    inline:
      # These come from https://nodejs.org/en/download/releases/
      - 'nvm install 12.18.3'
      - 'nvm install 10.22.0'
      - 'nvm install 8.17.0'
      - 'nvm install $env:NODEJS_VERSION'
      - 'nvm use $env:NODEJS_VERSION'
